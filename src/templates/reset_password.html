<!DOCTYPE html>
<html>
<head>
    <title>Restablecer Contraseña</title>
    <link rel="stylesheet" href="/static/style_reset_password.css">
</head>
<body>
    <div class="container">
        <div class="info">
            <h1>Restablecer Contraseña</h1>
            <span>Por favor ingresa tu nueva contraseña.</span>
        </div>
        <div class="form">
            <div class="thumbnail">
                <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/169963/hat.svg" alt="icono">
            </div>
            <form class="reset-form" id="reset-form">
                <input type="hidden" name="token" value="{{ token }}" id="reset-token">
                <input type="password" name="new_password" id="new-password" placeholder="Nueva contraseña" required>
                <input type="password" name="confirm_password" id="confirm-password" placeholder="Confirmar contraseña" required>
                <button type="submit">Restablecer</button>
                <div id="error-msg" style="color: red; margin-top: 10px;"></div>
                <div id="success-msg" style="color: green; margin-top: 10px;"></div>
            </form>
        </div>
    </div>
    <script>
    (function() {
        function getToken() {
            var resetTokenInput = document.getElementById('reset-token');
            if (resetTokenInput && resetTokenInput.value) return resetTokenInput.value;
            var tokenMatch = location.search.match(/[?&]token=([^&]+)/);
            return tokenMatch ? decodeURIComponent(tokenMatch[1]) : '';
        }

        var userAgent = navigator.userAgent.toLowerCase();
        var isAndroid = userAgent.indexOf('android') > -1;

        if (isAndroid) {
            var token = getToken();
            var deepLink = 'mychatbot://changePassword?token=' + encodeURIComponent(token);
            window.location.href = deepLink;
            setTimeout(function() {
                document.querySelector('.container').style.display = '';
            }, 800);
            document.querySelector('.container').style.display = 'none';
        }

        // Nueva lógica para manejar el submit y validación
        document.getElementById('reset-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            var password = document.getElementById('new-password').value;
            var confirmPassword = document.getElementById('confirm-password').value;
            var token = getToken();
            var errorMsg = document.getElementById('error-msg');
            var successMsg = document.getElementById('success-msg');
            errorMsg.textContent = '';
            successMsg.textContent = '';

            if(password !== confirmPassword) {
                errorMsg.textContent = 'Las contraseñas no coinciden.';
                return;
            }

            try {
                const response = await fetch('http://192.168.1.43:8000/users/reset-password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ token: token, password: password }),
                });
                if(response.ok) {
                    successMsg.textContent = '¡Contraseña restablecida correctamente!';
                    // Opcional: redireccionar o limpiar campos después de un tiempo.
                } else {
                    const data = await response.json().catch(() => ({}));
                    errorMsg.textContent = data.detail || 'Error al restablecer la contraseña.';
                }
            } catch (err) {
                errorMsg.textContent = 'Error de red o del servidor.';
            }
        });
    })();
    </script>
</body>
</html>
